<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Historique des commandes</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-green-50 to-yellow-50 min-h-screen text-gray-800">
    <div class="max-w-2xl mx-auto px-4 py-8">
        <nav class="mb-8 flex items-center gap-3">
            <a href="{% url 'menu' table.id %}" class="text-blue-600 hover:text-blue-800 text-2xl transition">‚Üê</a>
            <span id="history-title" class="text-2xl font-extrabold text-blue-800 tracking-tight flex items-center gap-2">
                <span>üìú</span> Historique des commandes
            </span>
        </nav>
        <div class="flex justify-end max-w-2xl mx-auto px-4 pt-4">
            <select id="language" onchange="changeLanguage()" class="px-3 py-2 rounded-lg border border-blue-200 bg-blue-50 focus:outline-none text-sm">
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
        </div>
        <div id="commandes-list"></div>
        <div class="mt-8 text-center">
            <a href="{% url 'menu' table.id %}" id="back-menu" class="inline-block px-6 py-2 rounded-lg bg-gradient-to-r from-blue-400 to-green-400 text-white font-semibold hover:from-blue-500 hover:to-green-500 transition shadow">
                ‚Üê Retour au menu
            </a>
        </div>
    </div>
    <footer class="mt-16 text-center">
        <div class="flex flex-col items-center gap-2 py-6">
            <div class="flex items-center gap-2 justify-center">
                <span class="text-2xl">üì±</span>
                <span id="footer-title" class="text-blue-700 font-bold text-lg">Menu QR Client</span>
            </div>
            <p id="footer-madeby" class="text-gray-500 text-sm">
                &copy; {% now "Y" %} R√©alis√© par HECHANE Abdellah &amp; FINIGUE Lahcen. Tous droits r√©serv√©s.
            </p>
            <div class="flex gap-2 justify-center mt-1">
                <span class="inline-block w-2 h-2 rounded-full bg-blue-400"></span>
                <span class="inline-block w-2 h-2 rounded-full bg-green-400"></span>
                <span class="inline-block w-2 h-2 rounded-full bg-yellow-400"></span>
            </div>
        </div>
    </footer>
    <script>
const translations = {
    fr: {
        historyTitle: "üìú Historique des commandes",
        backMenu: "‚Üê Retour au menu",
        noOrders: "Aucune commande trouv√©e",
        errorLoad: "Erreur de chargement",
        cancel: "Annuler la commande",
        date: "Date",
        total: "Total",
        menuClient: "Menu QR Client",
        madeBy: "R√©alis√© par HECHANE Abdellah & FINIGUE Lahcen. Tous droits r√©serv√©s.",
    },
    en: {
        historyTitle: "üìú Order History",
        backMenu: "‚Üê Back to menu",
        noOrders: "No orders found",
        errorLoad: "Loading error",
        cancel: "Cancel order",
        date: "Date",
        total: "Total",
        menuClient: "QR Menu Client",
        madeBy: "Made by HECHANE Abdellah & FINIGUE Lahcen. All rights reserved.",
    },
    ar: {
        historyTitle: "üìú ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",
        backMenu: "‚Üê ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
        noOrders: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™",
        errorLoad: "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ",
        cancel: "ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®",
        date: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ",
        total: "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ",
        menuClient: "ŸÇÿßÿ¶ŸÖÿ© QR ŸÑŸÑÿπŸÖŸäŸÑ",
        madeBy: "ÿ£ŸÜÿ¨ÿ≤Ÿá HECHANE Abdellah Ÿà FINIGUE Lahcen. ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©.",
    }
};

function changeLanguage() {
    const lang = document.getElementById('language').value;
    localStorage.setItem('selectedLanguage', lang);
    updateLanguage(lang);
}

function updateLanguage(lang) {
    document.getElementById('history-title').textContent = translations[lang].historyTitle;
    document.getElementById('back-menu').textContent = translations[lang].backMenu;
    document.getElementById('footer-title').textContent = translations[lang].menuClient;
    document.getElementById('footer-madeby').textContent = "¬© " + new Date().getFullYear() + " " + translations[lang].madeBy;

    // Traduction dynamique des commandes d√©j√† affich√©es
    document.querySelectorAll('.order-date').forEach(e => e.textContent = translations[lang].date + " :");
    document.querySelectorAll('.order-total').forEach(e => e.textContent = translations[lang].total + " :");
    document.querySelectorAll('.btn-cancel-order').forEach(e => e.textContent = translations[lang].cancel);
    // Si aucune commande
    const commandesList = document.getElementById('commandes-list');
    if (commandesList && commandesList.innerHTML.includes('noOrders')) {
        commandesList.innerHTML = `<p class="text-center text-gray-500">${translations[lang].noOrders}</p>`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const savedLang = localStorage.getItem('selectedLanguage') || 'fr';
    document.getElementById('language').value = savedLang;

    fetch(`/get-orders/{{ table.id }}/`)
        .then(response => response.json())
        .then(data => {
            const commandesList = document.getElementById('commandes-list');
            commandesList.innerHTML = '';

            if (data.orders && data.orders.length > 0) {
                data.orders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'mb-6 p-5 rounded-2xl shadow-lg bg-white/90 border-l-4 ' +
                        (order.status === 'en_attente_serveur' ? 'border-blue-400' :
                        order.status === 'nouvelle' ? 'border-red-400' :
                        order.status === 'preparation' ? 'border-yellow-400' :
                        order.status === 'prete' ? 'border-green-400' :
                        'border-gray-300');
                    orderDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-blue-900 text-lg">Commande #${order.id}</span>
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${
                                order.status === 'en_attente_serveur' ? 'bg-blue-100 text-blue-700' :
                                order.status === 'nouvelle' ? 'bg-red-100 text-red-700' :
                                order.status === 'preparation' ? 'bg-yellow-100 text-yellow-800' :
                                order.status === 'prete' ? 'bg-green-100 text-green-800' :
                                'bg-gray-200 text-gray-700'
                            }">${order.status}</span>
                        </div>
                        <div class="text-sm text-gray-700 mb-2 flex flex-col gap-1">
                            <p><span class="order-date font-semibold">${translations[savedLang].date} :</span> ${order.created_at}</p>
                            <p><span class="order-total font-semibold">${translations[savedLang].total} :</span> ${order.total_price} DH</p>
                        </div>
                        ${
                            order.status === 'en_attente_serveur'
                            ? `<button onclick="annulerCommande(${order.id})"
                                class="btn-cancel-order w-full py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition mt-2">
                                ${translations[savedLang].cancel}
                            </button>`
                            : ''
                        }
                    `;
                    commandesList.appendChild(orderDiv);
                });
            } else {
                commandesList.innerHTML = `<p class="text-center text-gray-500 noOrders">${translations[savedLang].noOrders}</p>`;
            }
            updateLanguage(savedLang);
        })
        .catch(error => {
            console.error("Erreur:", error);
            document.getElementById('commandes-list').innerHTML =
                `<p class="text-center text-red-500">${translations[savedLang].errorLoad}</p>`;
        });

    updateLanguage(savedLang);
});

function annulerCommande(orderId) {
    fetch(`/cancel-order/${orderId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Supprimer la commande de l'affichage
            const commandesList = document.getElementById('commandes-list');
            const commandes = commandesList.querySelectorAll('div');
            commandes.forEach(div => {
                if (div.innerHTML.includes(`Commande #${orderId}`)) {
                    div.remove();
                }
            });
            if (commandesList.children.length === 0) {
                commandesList.innerHTML = `<p class="text-center text-gray-500 noOrders">${translations[document.getElementById('language').value].noOrders}</p>`;
            }
        }
    });
}
    </script>
</body>
</html>